# ============================================
# printer.cfg – Duender CoreXY 
# ============================================

[include mmu/base/*.cfg]
[include mmu/optional/client_macros.cfg]
 
[virtual_sdcard]
path: ~/printer_data/gcodes
 
# ----------------------------
# Drucker-Kinematik
# ----------------------------
[printer]
kinematics: corexy
max_velocity: 300
max_accel: 8000
max_z_velocity: 10
max_z_accel: 200
square_corner_velocity: 5.0
 
# ----------------------------
# Z-Tilt (3 Z-Spindeln, 300x300 Bett)
# Z-Stepper (stepper_z/z1/z2) werden in der M8P-CFG definiert
# ----------------------------
[z_tilt]
z_positions:
    40, 40     # stepper_z → vorne links
    150, 260      # stepper_z1 → hinten mitte
    260, 40     # stepper_z2 → vorne rechts

points:
    40, 40
    150, 260
    260, 40

speed: 250
horizontal_move_z: 8
retries: 3
retry_tolerance: 0.05

 
# Hinweis:
# Eddy-spezifische Probe-Definition (mcu eddy, probe_eddy_current, bed_mesh,
# PROBE_EDDY_CURRENT_CALIBRATE_AUTO etc.) kommt vollständig aus sample-bigtreetech-eddy.cfg.
 
# ----------------------------
# Z Bottom Homing Macro
# (alle Z-Motoren nach unten auf mechanischen Anschlag)
# ----------------------------
[gcode_macro Z_BOTTOM_HOMING]
description: "Fahre Z komplett nach unten und setze Z=0 (mechanischer Nullpunkt)"
gcode:
    G91
    G1 Z-5 F6000
    G1 Z-500 F600      # alle Z-Stepper nach unten, Wert bei Bedarf anpassen
    G90
    SET_POSITION Z=0
    M84 S0             # Z-Stepper nicht sofort deaktivieren
 
# ----------------------------
# Z Safe Probe + Z-Tilt (Eddy übernimmt Z-Homing)
# ----------------------------
[gcode_macro Z_SAFE_PROBE]
description: "Sicher hochfahren, Z homen und Z_TILT_ADJUST mit Eddy"
gcode:
    G91
    G1 Z10 F6000       # relativ Z hoch
    G90
    G28 Z              # Z-Homing über Eddy (G28 ist in Eddy-CFG umdefiniert)
    Z_TILT_ADJUST
 
# ----------------------------
# START_PRINT Macro
# (ohne S-Parameter-Parsing für einfache Integration in Slicer)
# ----------------------------

[gcode_macro PRINT_START]
gcode:
    {% set BED_TEMP      = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}

    # 1. Bett-Heizung starten (ohne zu warten)
    M117 Preheating Bed...
    M140 S{BED_TEMP}
    
    # LED Effekte starten
    STOP_LED_EFFECTS LEDS="neopixel:hotend_leds (1)"
    SET_LED_EFFECT EFFECT=main_probing

    # 2. Homing und Kalibrierung
    M117 Homing...
    G28
    G90

    M117 Calibrating...
    Z_TILT_ADJUST
    BED_MESH_CALIBRATE

    # 3. Hotend Standby für MMU
    M117 MMU Loading...
    M104 S180 # Setzen ohne Warten
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=180 # Weiter sobald 180 erreicht

    # MMU Initialisierung
    MMU_START_LOAD_INITIAL_TOOL
    MMU_TTG_MAP TOOL=0 GATE=0 TOOL=1 GATE=1 TOOL=2 GATE=2 TOOL=3 GATE=3 TOOL=4 GATE=4 TOOL=5 GATE=5 TOOL=6 GATE=6 TOOL=7 GATE=7

    M104 S0

    # 4. Warten aufs Bett (Nur aufs Erreichen der Temp, kein Einpendeln)
    M117 Heating Bed (Fast)...
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TEMP}

    # 5. Hotend auf volle Drucktemperatur
    M117 Heating Extruder (Fast)...
    M104 S{EXTRUDER_TEMP}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={EXTRUDER_TEMP}

    # 6. Reinigung & Purge
    M117 Cleaning Nozzle...
    NOZZLE_WIPE
    
    M117 Purging...
    PURGE_LINE

    # 7. Start
    STOP_LED_EFFECTS LEDS="neopixel:hotend_leds (1)"
    SET_LED_EFFECT EFFECT=main_printing
    M117 Printing...
    G92 E0
 
# ----------------------------
# END_PRINT Macro (einfaches Platzhalter-Ende)
# ----------------------------

[gcode_macro PRINT_END]
gcode:
    TURN_OFF_HEATERS
    M107
    
    # 3mm hoch, Parken bei 0,303
    G91
    G1 Z3 F3000
    G90
    G1 X0 Y303 F6000

    MMU_END EJECT=1
    
    # Zurück auf Rot (Idle)
    STOP_LED_EFFECTS LEDS="neopixel:hotend_leds (1)"
    SET_LED_EFFECT EFFECT=main_idle
    
    M84
    M117 Done at 0,303
 
# ----------------------------
# RESET_CAN Macro 
# ----------------------------
[gcode_macro RESET_CAN]
gcode:
    RUN_SHELL_COMMAND CMD="/usr/local/bin/reset_can.sh"
 
[pause_resume]
 
[display_status]
 
# ----------------------------
# EBB36 
# ----------------------------
 
[mcu EBBCan]
#serial: /dev/serial/by-id/usb-Klipper_Klipper_firmware_12345-if00
canbus_uuid: 248db3d894f5
 
[board_pins EBB36_G0B1_v1.2]
aliases:
aliases_step:
    EXT_EN=PD2,EXT_STEP=PD0,EXT_DIR=PD1,EXT_UART=PA15
aliases_limitsw: # these are preferred for endstops (including klicky)
    LIMIT_1=PB7,LIMIT_2=PB5,LIMIT_3=PB6
aliases_bltouch: # these are the dupont connectors for bltouch
    PROBE_1=PB9,PROBE_2=PB8
aliases_fans:
    FAN0=PA1,FAN1=PA0
aliases_thermistors:
    TH0=PA3,PT100_CS=PA4,PT100_SCLK=PA5,PT100_MISO=PA6,PT100_MOSI=PA7
aliases_heaters:
    HE0=PA2
aliases_rgb:
    RGBLED=PD3
aliases_adxl:
    ADXL_CS=PB12,ADXL_SCLK=PB10,ADXL_MISO=PB2,ADXL_MOSI=PB11
aliases_i2c:
    AUX0=PB3,AUX1=PB4
 
[adxl345]
cs_pin: EBBCan: PB12
spi_bus: spi2_PB2_PB11_PB10
axes_map: x,y,z
 
[extruder]
step_pin: EBBCan: PD0
dir_pin: EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 16
rotation_distance: 4.68
nozzle_diameter: 0.4
filament_diameter: 1.75
heater_pin: EBBCan: PB13
max_extrude_only_distance: 120
 
sensor_type: MAX31865
sensor_pin: EBBCan: PA4      # passender CS-Pin für dein MAX31865-Slot
spi_bus: spi1
rtd_nominal_r: 1000          # PT1000
rtd_reference_r: 4300
rtd_num_of_wires: 2
 
control: pid
pid_kp: 21.527
pid_ki: 1.063
pid_kd: 108.982
min_temp: 0
max_temp: 350
 
 
[tmc2209 extruder]
uart_pin: EBBCan: PA15
run_current: 0.650
stealthchop_threshold: 999999
 
[fan]
pin: EBBCan: PA1
 
[heater_fan hotend_fan]
pin: EBBCan: PA0
heater: extruder
heater_temp: 50.0

#################################################################################################################
################################# Orbiter Sensor CONFIGURATION ##################################################
#################################################################################################################

#config file version v3.0.02
#release date: 22.12.2023

# PAUSE and RESUME macros are defined at the end of this config file.
# If you prefer using your own p[lease delete them, otherwise define parking position below.

#################################################################################################################
################################# CHANGE HERE MACRO CONFIGURABLES################################################
#################################################################################################################

[gcode_macro _SENSOR_VARIABLES]         # change here macro configurables, enable disable functions!*************************
variable_filament_load_temp     :220    # temperature to heat up hotend for filament loading, default is 235
variable_filament_unload_temp   :185    # temperature to heat up hotend for filament un-loading, default is 185
variable_filament_load_min_temp :190    # minimum hotend set temperature allowed in filament load macro, default is 190
variable_nozzle_purge_length    :100    # filament extrude amount during load sequenc, hotend purge from old filament, default is 200
variable_nozzle_purge_speed     :450    # filament extrude speed in mm/min adjust this value lower if flow is too high and extruder skips during loading, default is 300
variable_unload_distance        :65     # filament retract distance for unload procedure. this length shall be long enough to extract the filament above the drive gears
variable_disable_autoload       :False  # disable filament autoload feature by setting this variable True
variable_disable_runnout        :False  # disable runnout by setting this variable True
variable_disable_autochange     :False  # disable filament auto change after runnout detection
variable_disable_tangle         :True  # disable tangle by setting this variable True
variable_disable_autounload     :True  # disable auto unload filament by setting this variable to True
variable_enable_beep            :True   # uses M300 sound feature, set it True to enable
variable_park_position_x        :10     # edit your X parking position here for pause macro trigerred by runnout
variable_park_position_y        :10     # edit your Y parking position here for pause macro trigerred by runnout
variable_park_lift_z            :10     # edit your Z lift amount for parking position here, default is 10
Variable_park_retraction        :1      # edit your retraction amount for parking, default is 1
gcode:


#///////////////////////////filament sensor button macros/////////////////////////////////////////////////
#[gcode_button filament_sense]
#pin: !orbitoolO2:PA9 # remove the negation "!" for sensor v1 - use just PA9 as example
#pin: !orbitoolO2:PA13 # remove the negation "!" for sensor v1 - use just PA9 as example
#press_gcode: # sensor released  -runnout detected!
 
#release_gcode: #gcode macro for filament auto-load, sensor pressed
  #filament_load_init

#[filament_switch_sensor O2_sensor]
#switch_pin: ^EBBCan: PB6
#pause_on_runout: False
#runout_gcode: runnout_init
#insert_gcode: filament_load_init
#event_delay: 1.0
#pause_delay: 0.1

#********************************************************************************************************

#////////////////////////////////////////Filament Unload macros/////////////////////////////////////////////////
#[gcode_button filament_unload]
#pin: EBBCan: PB7 # remove the negation "!" for sensor v1 - use just PA9 as example
#press_gcode:  # filament unload procedure   
#  unload_tangle_init
#release_gcode: # do not add any macro call here

#################################################################################################################################
####################################### DO NOT CHANGE ANYTHING BELOW THIS LINE!!! ###############################################
#################################################################################################################################
####################################### UNLESS YOU KNOW WHAT YOU ARE DOING OR YOU ARE BORED AND NEED TO DO SOMETHING OR YOU ARE ALONE AND NEED SOMETHING TO MESS UP YOUR LIFE OR YOU CAN DO IT BETTER THAN ME OR YOU ARE A REAL SMARTASS OR JUST BECAUSE YOU CAN OR YOU RUN OUT OF BEAR OR HAS NOTHING BETTER TO DO OR ANY UNREASONABLE REASON
#################################################################################################################################

[respond]
default_type: echo

[force_move]
enable_force_move: True

[gcode_macro runnout_init]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %}  
  {% if(sensor.disable_runnout|lower == 'false') %}
      filament_change_state1
  {% else %}
    M118 Filament runnout is disabled in the sensor config file!   
  {% endif %} 

[gcode_macro filament_change_state1]
variable_changebusy: 0
variable_temp_target: 0
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %}  
  {% if changebusy == 0 %}
    PAUSE # call printer pause macro          
    M118 Filament runnout!       
    {% if (sensor.disable_autochange|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=filament_change_state1 VARIABLE=changebusy VALUE=1       
      filament_change_state2   # comment this line if you do not want to automatically unload filament in case there is a runnout detected.
    {% endif %}  
  {% endif %}

[gcode_macro filament_change_state2]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %}  
  SET_GCODE_VARIABLE MACRO=unload_tangle_init VARIABLE=loadbusy VALUE=1  
  {% if (sensor.enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  M118 Unloading filament...   
  M83
  G92 E0   
  # {% if printer[printer.toolhead.extruder].temperature < 185 %} # hardcoded threshold
  {% if (printer.extruder.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder config (to about 185)
      M118 Hotend heating!        
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.filament_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.filament_unload_temp} #wait for reaching filament unload temp
      {% endif %}     
  {% if(printer.extruder.target == 0) %} # checing for set temperature if is zero than set to 200 / hotend hot but cooling due to set target temp 0
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.filament_unload_temp} # restore user temp if it was set before loading
      TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.filament_unload_temp} #wait for reaching filament unload temp
  {% endif %} 
  G0 E-5 F3600 	#extract filament to cold end
  G4 P2000 # wait for two seconds
  G0 E5 F3600 # push the filament back 
  G0 E-5 F3600 	#extract filament to cold end
  G0 E-{sensor.unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
  M400   
  M118 Load new filament! Wait until is loaded, then resume printing.  
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0 # swicth off heater
  UPDATE_DELAYED_GCODE ID=clear_loadbusy DURATION=0.5
  UPDATE_DELAYED_GCODE ID=clear_changebusy DURATION=0.5

[gcode_macro filament_load_init]
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %}
  {% if (printer.print_stats.state != "printing") %}
    {% if(sensor.disable_autoload|lower == 'false') %}
      SET_GCODE_VARIABLE MACRO=unload_tangle_init VARIABLE=loadbusy VALUE=1
      filament_load
    {% else %}
    M118 Filament auto-load is disabled in the sensor config file!   
    {% endif %} 
  {% else %}    
    M118 Printing! Can't load filament right now!    
  {% endif %} 
 # SET_GCODE_VARIABLE MACRO=filament_unload VARIABLE=filamentpresent VALUE=1
  #UPDATE_DELAYED_GCODE ID=clear_changebusy DURATION=2  

[gcode_macro filament_load]
variable_USER_TEMP: 0
variable_LOAD_TEMP: 0
gcode:    
    {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %}
      {% set USER_TEMP = printer.extruder.target %} # save user set temperature before loading
      {% set LOAD_TEMP = 0 %} 
      #M118 USER TEMP {USER_TEMP}      # echo back for debug only      
        {% if (printer.extruder.can_extrude|lower != 'true') or (printer.extruder.target < sensor.filament_load_min_temp) %} # checking for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder config (to about 185)                        
          SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.filament_load_temp} # set user defined load temperature
          {% set LOAD_TEMP = sensor.filament_load_temp %} # save user set temperature before loading           
         M118 Hotend heating! 
        {% endif %}     
    {% if (sensor.enable_beep|lower == 'true') %} 
      M300 # beep sound
    {% endif %}
    M118 Filament loading!  
    M82           #set extruder to absolute mode
    G92 E0
    G4 P1500        # wait for 1.5 seconds
    FORCE_MOVE STEPPER=extruder DISTANCE=15 VELOCITY=10 ACCEL=1000  # load filament inside the gears force move needs to be enabled    
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={LOAD_TEMP} # wait for reaching set temperature    
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={USER_TEMP} # wait for reaching set temperature    
    G1 E{sensor.nozzle_purge_length} F{sensor.nozzle_purge_speed} # extrude preconfigured purge length
    M400 # wait to complete nozzle purge
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={USER_TEMP} # restore user temp if it was set before loading
    M118 Filament load complete!   
    UPDATE_DELAYED_GCODE ID=clear_loadbusy DURATION=2   
 

#############################################END filament auto load macro section END***********************************************************
#############################################filament auto unload and Tangle macro section*****************************************************************
[gcode_macro unload_tangle_init]
variable_loadbusy: 0
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %}
  {% if (printer.print_stats.state == "printing") %} # filament tangle detection during printing  
    {% if(sensor.disable_tangle|lower == 'false') %} # run tangle detection macro if enabled
      filament_tangle   
    {% else %} #filament tangle disabled send message to console
      M118 Filament tangle detected, action disabled!
    {% endif %} 
  {% else %} #filament unload button pressed
      {% if (printer.print_stats.state != "paused" and loadbusy == 0) %} #enable unload if not printing and not paused
        {% if(sensor.disable_autounload|lower == 'false') %} # run unload macro if enabled
          filament_unload
        {% endif %}
      {% endif %}
  {% endif %}

[gcode_macro filament_unload] 
#variable_filamentpresent: 0
gcode:
    {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %}
      {% if (sensor.enable_beep|lower == 'true') %} 
        M300 # beep sound
      {% endif %}
      M118 Filament unloading!    
      M83
      G92 E0     
      {% if (printer.extruder.can_extrude|lower != 'true')%} # checing for minimum extrusion temperature
        # check if temperature is over the minimum extrusion temp. min_extrude_temp must be defined in the extruder config (to about 185)
        M118 Hotend heating!          
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={sensor.filament_unload_temp} # restore user temp if it was set before loading
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.filament_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      {% if(printer.extruder.target == 0) %} # checing for set temperature if is zero than set to 185 / hotend hot but cooling due to set target temp 0
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={sensor.filament_unload_temp} # wait for reaching configured unload temperature
      {% endif %}
      G0 E10 F500 # extruder 20mm of filament before extracting 
      G0 E-5 F3600 	#extract filament to cold end
      G4 P2000 # wait for two seconds
      G0 E6 F3600 # push the filament back 
      G0 E-10 F3600 	#extract filament to cold end
      G0 E-{sensor.unload_distance} F300	# continue extraction slow allow filament to be cooled enough before reaches the gears  
      M104 S0 T0 
      M400 # wait to complete unload
      M118 Filament unload complete!    

[gcode_macro filament_tangle] 
gcode:
  {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %}
  M118 Filament tangle detected, print paused!
  {% if (sensor.enable_beep|lower == 'true') %} 
    M300 # beep sound
  {% endif %}
  PAUSE

[gcode_macro PURGE_LINE]
description: Prime line entlang X von X0 Y0
variable_purge_len: 260     # Linienlänge in mm
variable_purge_e: 70         # Purge-Menge in mm Filament (für UHF)
variable_purge_z: 0.25       # Druckhöhe der Linie
variable_travel_f: 9000      # Travel-Speed (mm/min)
variable_purge_f: 3000       # Purge-Speed (mm/min)

gcode:
    SAVE_GCODE_STATE NAME=purge_state

    G92 E0                      ; Extruder nullen
    G90                         ; absolute Koordinaten

    ; An die Startkante fahren (vorne links)
    G1 Z5 F{travel_f}
    G1 X0 Y0 F{travel_f}
    G1 Z{purge_z} F{travel_f}

    ; leichte Vorförderung
    G1 E2 F{purge_f}

    ; Purge-Line in +X Richtung
    G1 X{purge_len} E{purge_e} F{purge_f}

    ; Faden brechen & hoch
    G1 X{purge_len+5} F{travel_f}
    G1 Z5 F{travel_f}
    G92 E0

    RESTORE_GCODE_STATE NAME=purge_state


[gcode_macro NOZZLE_WIPE]
variable_wipe_x1: 276
variable_wipe_x2: 240
variable_wipe_y: -29
variable_wipe_speed: 6000

gcode:
    SAVE_GCODE_STATE NAME=wipe_state
    
    RESPOND PREFIX=WIPE MSG="Start Wipe"
    G1 Z5 F3000                           # Nur anheben
    
    G1 X{wipe_x1} Y{wipe_y} F{wipe_speed}  # Zum Pad
    {% for wipe in range(3) %}
        RESPOND PREFIX=WIPE MSG="Wipe {wipe+1}"
        G1 X{wipe_x2} F12000
        G1 X{wipe_x1} F12000
    {% endfor %}
    
    RESTORE_GCODE_STATE NAME=wipe_state    # ← ALLES wird zurückgesetzt (X,Y,Z, E, F, etc.)
    RESPOND PREFIX=WIPE MSG="Wipe komplett"
    

#############################################END filament auto unload macro section END***********************************************************

[delayed_gcode clear_unloadbusy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_unload VARIABLE=unloadbusy VALUE=0
  #M118 Clear Unload busy! 

[delayed_gcode clear_changebusy]
gcode:
  SET_GCODE_VARIABLE MACRO=filament_change_state1 VARIABLE=changebusy VALUE=0
  #M118 Clear Load busy!  

[delayed_gcode clear_loadbusy]
gcode:
  SET_GCODE_VARIABLE MACRO=unload_tangle_init VARIABLE=loadbusy VALUE=0
  #M118 Clear Load busy!  


#################################################################################################################################
##################### DELETE PAUSE AND RESUME MACROS IF YOU WANT TO USE YOUR OWN ONES!###########################################
#################################################################################################################################


#####################################################################
# LED EFFEKTE (Plugin: klipper-led_effect)
#####################################################################

[neopixel hotend_leds]
pin: EBBCan:PD3
chain_count: 4
color_order: GRBW

# --- UNTEN: IMMER WEISS ---
[led_effect sequins_permanent]
leds:
    neopixel:hotend_leds (2,3)
autostart:              true
frame_rate:             1
layers:
    static  1 0 top (0,0,0,1) # Nutzt nur den weißen Kanal

# --- OBEN: STATUS-EFFEKTE ---
[led_effect main_idle]
leds:
    neopixel:hotend_leds (1)
autostart:              true
frame_rate:             24
layers:
    static  1 0 top (1,0,0,0) # Rot

[led_effect main_probing]
leds:
    neopixel:hotend_leds (1)
autostart:              false
frame_rate:             24
layers:
    breathing  3 1 top (0,0,1,0) # Blaues Atmen während Probe

[led_effect main_printing]
leds:
    neopixel:hotend_leds (1)
autostart:              false
frame_rate:             24
layers:
    static  1 0 top (0,1,0,0) # Grün

[led_effect main_error]
leds:
    neopixel:hotend_leds (1)
autostart:              false
frame_rate:             24
layers:
    blink  1 1 top (1,0,0,0) # Schnelles rotes Blinken
 
# ============================================
# Eddy USB – angepasste Config für 300x300
# ============================================
 
# The MCU section only applies to the Eddy USB. For Eddy Coil you will use the MCU name of the toolboard that you connected the Eddy Coil to.
[mcu eddy]
canbus_uuid: 10afd2d612d2

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu # Sets the type of sensor for Klipper to read
sensor_mcu: eddy # Sets the MCU of the eddy probe tempereature sensor
min_temp: 10 # Sets the minimum tempereature for eddys tempereature sensor to operate
max_temp: 100 # Sets the maximum tempereature for eddys tempereature sensor to operate

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
z_offset: 2.5
i2c_mcu: eddy  # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the MCU you have used.
i2c_bus: i2c0f # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the I2C bus you have used.
x_offset: 0
y_offset: 25

# This section is only relevant for Eddy USB. Comment it out for Eddy Coil.
[temperature_probe btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
horizontal_move_z: 2

[bed_mesh]
horizontal_move_z: 2
speed: 200
mesh_min: 5,8 
mesh_max: 303,285
probe_count: 20, 20
algorithm: bicubic
#scan_overshoot: 8  #uncomment this section if you still have room left over on the X axis for some scan overshoot to product smoother movements and more accurate scanning. Uncommenting this should be fine if you are using a standard voron mount.

# Uncomment this if you are using Eddy as the probe AND the homing endstop
[safe_z_home]
home_xy_position: 150, 150 # Choose an X,Y position that is in the center of your bed. For a 300x300 machine that will be 150, 150. Use the same principle to calculate your bed center.
z_hop: 10
z_hop_speed: 25
speed: 200

###############################Macros and related################################
#This secton contains macros and related config sections. Some should be used, others are optional. Read the comment above each one to find out whether or not to uncomment it for your installation.


# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[save_variables]
filename: ~/printer_data/config/variables.cfg



# Uncomment this if you are using Eddy as the probe AND the homing endstop
[force_move]
enable_force_move: True # Allows a user to move the z axis down if they have no other means of homing Z and need to calibrate the Eddy.



# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[delayed_gcode RESTORE_PROBE_OFFSET]
initial_duration: 1.
gcode:
  {% set svv = printer.save_variables.variables %}
  {% if not printer["gcode_macro SET_GCODE_OFFSET"].restored %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ svv.nvm_offset|default(0) }
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=restored VALUE=True
  {% endif %}



# Uncomment this if you are using Eddy as the probe AND the homing endstop
# Take note of the lines that should only be used if you have a KNOMI installed.
[gcode_macro G28]
rename_existing: G28.1
gcode:
  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=True # Uncomment this if using a KNOMI and then remove the G28 macro from the KNOMI.cfg
  G28.1 {rawparams}
  {% if not rawparams or (rawparams and 'Z' in rawparams) %}
    PROBE
    SET_Z_FROM_PROBE
  {% endif %}
  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=False # Uncomment this if using a KNOMI and then remove the G28 macro from the KNOMI.cfg



# Uncomment this if you are using Eddy as the probe AND the homing endstop
[gcode_macro SET_Z_FROM_PROBE]
gcode:
    {% set cf = printer.configfile.settings %}
    SET_GCODE_OFFSET_ORIG Z={printer.probe.last_z_result - cf['probe_eddy_current btt_eddy'].z_offset + printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset}
    G90
    G1 Z{cf.safe_z_home.z_hop}


# Uncomment this if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro Z_OFFSET_APPLY_PROBE]
rename_existing: Z_OFFSET_APPLY_PROBE_ORIG
gcode:
  SAVE_VARIABLE VARIABLE=nvm_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset }



# Uncomment the lines in this macro if you are using Eddy as the probe AND the homing endstop AND would like to use the beta z-offset control
[gcode_macro SET_GCODE_OFFSET]
rename_existing: SET_GCODE_OFFSET_ORIG
variable_restored: False  # Mark whether the var has been restored from NVM
variable_runtime_offset: 0
gcode:
  {% if params.Z_ADJUST %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset + params.Z_ADJUST|float }
  {% endif %}
  {% if params.Z %} 
    {% set paramList = rawparams.split() %}
    {% for i in range(paramList|length) %}
      {% if paramList[i]=="Z=0" %}
        {% set temp=paramList.pop(i) %}
        {% set temp="Z_ADJUST=" + (-printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset)|string %}
        {% if paramList.append(temp) %}{% endif %}
      {% endif %}
    {% endfor %}
    {% set rawparams=paramList|join(' ') %}
    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE=0
  {% endif %}
  SET_GCODE_OFFSET_ORIG { rawparams }



# This macro automates a lot of the frequency mapping process and simplifies the steps significantly.
[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
  BED_MESH_CLEAR
  G28 X Y
  G90 # Abs positioning
  G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 } # Allows the user to work it down until it touches.
  {% endif %}
  PROBE_EDDY_CURRENT_CALIBRATE {rawparams}



#This macro is optional but useful if you want to run a rapid scan before each print. Simply uncomment it and add BED_MESH_SCAN to your print start code.
[gcode_macro BED_MESH_CALIBRATE]
rename_existing: BTT_BED_MESH_CALIBRATE
gcode:
  BTT_BED_MESH_CALIBRATE METHOD=rapid_scan
  
# ----------------------------
# M8P V2 
# ----------------------------
 
 
# Motor1
[stepper_x]
step_pin: PE6
dir_pin: PE5
enable_pin: !PC14
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_endstop: 0
position_max: 305
homing_speed: 50
 
 
# Motor2
[stepper_y]
step_pin: PE2
dir_pin: PE1
enable_pin: !PE4
microsteps: 16
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: 303
position_min: -30
position_max: 303
homing_speed: 50

 
# Z-hinten Mitte
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 410
position_min: -15.0
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 3
homing_positive_dir: false
 
# Z-vorne Links
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
microsteps: 16
rotation_distance: 8

 
# Z-vorne rechts
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
microsteps: 16
rotation_distance: 8

 
########################################
# TMC2226 configuration (KORRIGIERT!)
########################################
 
[tmc2209 stepper_x]
uart_pin: PC13
diag_pin: PF4
run_current: 0.75
hold_current: 0.45
stealthchop_threshold: 0
driver_SGTHRS: 60

[tmc2209 stepper_y]
uart_pin: PE3
diag_pin: PF3
run_current: 0.75
hold_current: 0.45
stealthchop_threshold: 0
driver_SGTHRS: 60
 
# Motor3
[tmc2209 stepper_z]
uart_pin: PB9
#diag_pin: PF2
run_current: 0.8
stealthchop_threshold: 999999
 
# Motor4
[tmc2209 stepper_z1]
uart_pin: PB5
#diag_pin: PF1
run_current: 0.8
stealthchop_threshold: 999999
 
# Motor5
[tmc2209 stepper_z2]
uart_pin: PG14
run_current: 0.8
stealthchop_threshold: 999999
 
 
## End-Stop 5
#[filament_switch_sensor material_0]
#switch_pin: PF0
 
## Motor6
#[extruder1]
#step_pin: PG9
#dir_pin: PD7
#enable_pin: !PG11 
#heater_pin: PA1 # HE1 
#sensor_pin: PC5 # T1
#...
 
## End-Stop 6
#[filament_switch_sensor material_1]
#switch_pin: PC15
 
## Motor7
#[extruder2]
#step_pin: PD4
#dir_pin: PD3
#enable_pin: !PD6
#heater_pin: PA3 # HE2
#sensor_pin: PC4 # T2
#...
 
## Motor8
#[extruder3]
#step_pin: PC7
#dir_pin: PC8
#enable_pin: !PD2
#heater_pin: PA5 # HE3
#sensor_pin: PA7 # T3
#...
 
[heater_bed]
heater_pin: PF5
sensor_pin: PB0 # TB 
sensor_type: ATC Semitec 104GT-2
control: watermark
min_temp: 0
max_temp: 130
 
#[fan_generic soc-fan]
#pin: host:gpio79  #CB1
#pin: host:gpio26  #CM4
 
 
[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_4C002C000F51313531383332-if00
canbus_uuid: 7a8f1f811139 
 
[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE7, EXP1_2=PG1,
    EXP1_3=PG0, EXP1_4=PF15,
    EXP1_5=PF14, EXP1_6=PF13,    # Slot in the socket on this side
    EXP1_7=PF12, EXP1_8=PF11,
    EXP1_9=<GND>, EXP1_10=<5V>,
 
    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PE15, EXP2_4=PE11,
    EXP2_5=PE10, EXP2_6=PE14,      # Slot in the socket on this side
    EXP2_7=PE8, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>

#####################################################################
# ELEKTRONIK-KÜHLUNG (Leviathan Board)
#####################################################################

# FAN 0: CM5 Kühlung
[controller_fan CM5_fan]
pin: PF7
max_power: 1.0
shutdown_speed: 1.0
cycle_time: 0.010
hardware_pwm: False
# Der Lüfter geht an, sobald ein Stepper oder der Extruder aktiv ist
stepper: stepper_x, stepper_y, stepper_z, extruder 
idle_timeout: 60          # Läuft nach dem Druck noch 60 Sek. nach
fan_speed: 0.6            # Läuft auf 60% (leiser), reicht für das CM5 meist aus

# FAN 1: Stepper-Treiber Kühlung
[controller_fan stepper_fan]
pin: PF9
max_power: 1.0
shutdown_speed: 1.0
cycle_time: 0.010
hardware_pwm: False
stepper: stepper_x, stepper_y, stepper_z
idle_timeout: 90          # Die Treiber bleiben gerne etwas länger warm
fan_speed: 0.8            # 80% Power für die TMC-Treiber

## Fan2
#[heater_fan fan2]
#pin: PF6
 
## Fan3
#[heater_fan fan3]
#pin: PF8
 
## Fan4
#[heater_fan fan4]
#pin: PA4
 
## Fan5
#[heater_fan fan5]
#pin: PA6
#tachometer_pin: PC2
 
## Fan6
#[heater_fan fan6]
#pin: PA2
#tachometer_pin: PC1


# See the sample-lcd.cfg file for definitions of common LCD displays.
 
#[adxl345]
#cs_pin: PA15
#spi_bus: spi3a
 
#[bltouch]
#sensor_pin: PD13
#control_pin: PD12
 
## Proximity switch
#[probe]
#pin: PD8
 
#[output_pin ps_on_pin]
#pin: PD14
 
#[neopixel my_neopixel_1]
#pin: PD15
 
#[hall_filament_width_sensor]
#adc1: PC0
#adc2: PF10

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3242670.552,0.090000:3241533.161,0.130000:3240375.692,
#*# 	0.170000:3239339.795,0.210000:3238248.609,0.250000:3237191.920,
#*# 	0.290000:3236127.568,0.330000:3235178.614,0.370000:3234186.382,
#*# 	0.410000:3233233.615,0.450000:3232339.570,0.490000:3231422.446,
#*# 	0.530000:3230522.438,0.570000:3229640.703,0.610000:3228778.805,
#*# 	0.650000:3227902.796,0.690000:3227023.051,0.730000:3226176.959,
#*# 	0.770000:3225332.415,0.810000:3224528.800,0.850000:3223691.973,
#*# 	0.890000:3222881.105,0.930000:3222074.838,0.970000:3221280.130,
#*# 	1.010000:3220497.905,1.050000:3219700.043,1.090000:3218895.230,
#*# 	1.130000:3218175.085,1.170000:3217472.592,1.210000:3216693.454,
#*# 	1.250000:3215978.855,1.290000:3215271.835,1.330000:3214552.388,
#*# 	1.370000:3213875.626,1.410000:3213191.468,1.450000:3212552.115,
#*# 	1.490000:3211918.867,1.530000:3211261.756,1.570000:3210598.018,
#*# 	1.610000:3209968.168,1.650000:3209343.263,1.690000:3208760.821,
#*# 	1.730000:3208127.763,1.770000:3207548.330,1.810000:3206942.865,
#*# 	1.850000:3206395.410,1.890000:3205837.619,1.930000:3205304.824,
#*# 	1.970000:3204761.689,2.010000:3204250.284,2.050000:3203698.796,
#*# 	2.090000:3203213.730,2.130000:3202712.259,2.170000:3202239.173,
#*# 	2.210000:3201773.715,2.250000:3201272.283,2.290000:3200791.495,
#*# 	2.330000:3200339.414,2.370000:3199866.974,2.410000:3199425.200,
#*# 	2.450000:3199007.453,2.490000:3198559.695,2.530000:3198140.602,
#*# 	2.570000:3197730.480,2.610000:3197330.076,2.650000:3196939.697,
#*# 	2.690000:3196546.540,2.730000:3196158.498,2.770000:3195784.101,
#*# 	2.810000:3195393.986,2.850000:3195047.140,2.890000:3194695.791,
#*# 	2.930000:3194334.405,2.970000:3193988.433,3.010000:3193625.942,
#*# 	3.050000:3193288.289,3.090000:3192995.544,3.130000:3192652.795,
#*# 	3.170000:3192341.630,3.210000:3192031.124,3.250000:3191714.037,
#*# 	3.290000:3191428.392,3.330000:3191129.390,3.370000:3190844.008,
#*# 	3.410000:3190548.243,3.450000:3190257.992,3.490000:3189959.452,
#*# 	3.530000:3189679.520,3.570000:3189428.505,3.610000:3189191.324,
#*# 	3.650000:3188908.390,3.690000:3188657.033,3.730000:3188390.356,
#*# 	3.770000:3188162.180,3.810000:3187923.687,3.850000:3187665.512,
#*# 	3.890000:3187453.036,3.930000:3187235.107,3.970000:3187008.716,
#*# 	4.010000:3186760.015,4.050000:3186573.653
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 26.760916
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.182077, 0.014186, 0.029826, 0.041350, 0.044253, 0.045640, 0.041951, 0.049172, 0.059753, 0.066342, 0.074424, 0.088503, 0.102118, 0.128609, 0.155299, 0.184397, 0.220842, 0.272668, 0.315685, -0.421955
#*# 	  -0.176880, 0.007350, 0.014505, 0.024784, 0.032285, 0.028368, 0.020866, 0.033057, 0.045169, 0.047013, 0.044711, 0.056236, 0.068045, 0.090062, 0.112919, 0.140415, 0.154846, 0.187448, 0.218492, -0.584281
#*# 	  -0.200525, -0.014943, -0.007497, 0.001475, 0.003420, -0.005526, -0.009136, -0.008305, 0.004073, 0.007991, -0.001457, 0.010922, 0.014019, 0.036418, 0.058222, 0.070969, 0.091943, 0.118599, 0.149535, -0.701915
#*# 	  -0.212845, -0.007831, -0.016142, -0.021140, -0.020533, -0.024154, -0.028390, -0.026884, -0.021745, -0.027038, -0.037009, -0.030064, -0.023406, -0.009290, 0.004392, 0.007171, 0.031514, 0.043167, 0.063598, -0.711791
#*# 	  -0.233126, -0.016617, -0.029152, -0.032165, -0.035645, -0.043205, -0.045625, -0.057380, -0.046386, -0.057893, -0.065976, -0.064249, -0.065624, -0.051188, -0.039120, -0.034885, -0.027180, -0.016000, -0.002762, -0.798309
#*# 	  -0.266546, -0.041543, -0.042005, -0.041687, -0.052050, -0.060634, -0.070431, -0.076788, -0.084182, -0.095353, -0.099337, -0.104154, -0.096018, -0.087274, -0.084521, -0.092026, -0.079880, -0.062360, -0.052902, -0.820144
#*# 	  -0.261690, -0.049401, -0.050336, -0.051188, -0.055655, -0.073347, -0.091688, -0.095851, -0.107481, -0.119274, -0.128580, -0.132549, -0.136424, -0.133254, -0.130790, -0.132897, -0.123435, -0.124764, -0.118945, -0.911742
#*# 	  -0.268972, -0.029900, -0.036403, -0.048795, -0.061510, -0.076275, -0.097518, -0.110631, -0.125263, -0.137657, -0.157219, -0.156334, -0.163379, -0.161620, -0.167255, -0.180645, -0.182252, -0.170429, -0.177951, -0.917515
#*# 	  -0.227973, -0.013424, -0.027644, -0.045483, -0.048796, -0.080403, -0.098005, -0.113790, -0.134656, -0.151228, -0.164612, -0.181890, -0.186552, -0.188515, -0.202494, -0.212844, -0.216002, -0.213671, -0.217833, -0.995707
#*# 	  -0.241601, -0.005539, -0.027941, -0.035644, -0.046980, -0.077137, -0.101004, -0.118279, -0.138362, -0.161790, -0.184938, -0.198187, -0.212514, -0.215835, -0.230967, -0.243928, -0.249413, -0.246751, -0.263772, -0.988783
#*# 	  -0.234455, -0.011917, -0.017649, -0.033387, -0.045022, -0.073358, -0.098343, -0.116452, -0.139594, -0.172941, -0.191744, -0.216830, -0.234787, -0.236448, -0.254062, -0.270014, -0.284924, -0.287524, -0.295469, -1.093437
#*# 	  -0.241601, 0.009462, -0.006999, -0.022041, -0.034742, -0.063911, -0.091689, -0.118288, -0.146289, -0.171152, -0.203742, -0.216002, -0.239769, -0.255800, -0.275098, -0.287004, -0.305793, -0.316854, -0.338599, -1.059321
#*# 	  -0.204994, 0.030442, 0.007990, -0.007165, -0.025519, -0.056342, -0.088486, -0.106816, -0.132719, -0.169021, -0.199440, -0.227474, -0.256662, -0.270705, -0.288040, -0.312061, -0.336131, -0.357654, -0.376785, -1.137155
#*# 	  -0.193352, 0.065886, 0.043653, 0.018422, -0.003427, -0.044107, -0.070607, -0.093178, -0.119939, -0.163906, -0.199621, -0.230466, -0.255625, -0.281281, -0.299524, -0.318147, -0.336658, -0.366121, -0.393389, -1.116565
#*# 	  -0.135710, 0.103515, 0.072077, 0.045011, 0.025256, -0.011169, -0.051188, -0.071982, -0.101659, -0.149468, -0.192461, -0.226307, -0.257182, -0.282497, -0.304503, -0.333484, -0.361006, -0.375465, -0.401690, -1.119978
#*# 	  -0.104829, 0.150435, 0.117094, 0.087233, 0.054391, 0.017922, -0.022955, -0.049400, -0.088474, -0.131148, -0.183512, -0.219659, -0.244430, -0.279374, -0.307083, -0.334188, -0.359947, -0.390558, -0.415770, -1.094442
#*# 	  -0.034742, 0.199640, 0.163233, 0.128609, 0.095383, 0.052074, 0.007019, -0.026884, -0.066992, -0.107642, -0.167611, -0.204277, -0.244096, -0.267933, -0.295654, -0.325706, -0.360124, -0.371503, -0.389804, -1.115595
#*# 	  -0.004720, 0.249921, 0.211354, 0.176481, 0.136531, 0.088021, 0.037648, -0.001135, -0.042753, -0.091023, -0.138720, -0.185294, -0.225971, -0.254582, -0.289604, -0.307637, -0.340186, -0.370183, -0.401314, -1.049170
#*# 	  0.086157, 0.307435, 0.268337, 0.225115, 0.188197, 0.137284, 0.076770, 0.037204, -0.008803, -0.048488, -0.106985, -0.157389, -0.206787, -0.234456, -0.260132, -0.294364, -0.324231, -0.350243, -0.380747, -1.040542
#*# 	  0.138481, 0.381217, 0.330962, 0.280588, 0.232658, 0.181031, 0.122330, 0.072543, 0.024451, -0.022184, -0.070781, -0.121784, -0.165952, -0.216834, -0.244429, -0.262384, -0.268626, -0.296389, -0.344422, -0.954028
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 5.0
#*# max_x = 302.92
#*# min_y = 8.0
#*# max_y = 284.8299999999999
